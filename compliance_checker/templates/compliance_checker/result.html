{% extends 'compliance_checker/base.html' %}
{% load static %}
{% load compliance_extras %}

{% block title %}분석 결과 - 의료광고법 준수 검토 시스템{% endblock %}

{% block extra_css %}
<style>
    .result-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .result-header {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        text-align: center;
    }
    
    .result-header h1 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 1rem;
    }
    
    .score-display {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 2rem 0;
    }
    
    .score-circle {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        font-weight: bold;
        position: relative;
    }
    
    .score-circle.high {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .score-circle.medium {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    
    .score-circle.low {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .score-number {
        font-size: 2rem;
        font-weight: 700;
    }
    
    .score-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .status-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        margin-top: 1rem;
    }
    
    .status-compliant {
        background: #d1fae5;
        color: #065f46;
    }
    
    .status-partial {
        background: #fef3c7;
        color: #92400e;
    }
    
    .status-noncompliant {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .result-tabs {
        display: flex;
        background: white;
        border-radius: 12px;
        padding: 0.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow-x: auto;
    }
    
    .result-tab {
        flex: 1;
        padding: 1rem 1.5rem;
        text-align: center;
        background: transparent;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        color: #6b7280;
        transition: all 0.3s ease;
        white-space: nowrap;
        min-width: 120px;
    }
    
    .result-tab.active {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .result-tab:hover:not(.active) {
        background: #f3f4f6;
        color: #374151;
    }
    
    .content-section {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: none;
    }
    
    .content-section.active {
        display: block;
        animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 3px solid #3b82f6;
    }
    
    .violation-card {
        background: #f8fafc;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border-left: 4px solid;
        transition: all 0.3s ease;
    }
    
    .violation-card.high {
        border-left-color: #ef4444;
        background: #fef2f2;
    }
    
    .violation-card.medium {
        border-left-color: #f59e0b;
        background: #fffbeb;
    }
    
    .violation-card.low {
        border-left-color: #10b981;
        background: #f0fdf4;
    }
    
    .violation-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .violation-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1f2937;
    }
    
    .violation-severity {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .severity-high {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .severity-medium {
        background: #fef3c7;
        color: #92400e;
    }
    
    .severity-low {
        background: #d1fae5;
        color: #065f46;
    }
    
    .violation-details {
        margin-bottom: 1rem;
    }
    
    .violation-keyword {
        background: #e5e7eb;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.9rem;
        margin-right: 0.5rem;
    }
    
    .violation-context {
        background: #f3f4f6;
        padding: 1rem;
        border-radius: 6px;
        margin: 0.5rem 0;
        font-style: italic;
        border-left: 3px solid #3b82f6;
    }
    
    .violation-suggestions {
        background: #eff6ff;
        padding: 1rem;
        border-radius: 6px;
        margin-top: 1rem;
    }
    
    .suggestion-item {
        margin-bottom: 0.5rem;
        padding-left: 1rem;
        position: relative;
    }
    
    .suggestion-item:before {
        content: "•";
        position: absolute;
        left: 0;
        color: #3b82f6;
        font-weight: bold;
    }
    
    .text-analysis {
        background: #f8fafc;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .analysis-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .analysis-item {
        background: white;
        padding: 1rem;
        border-radius: 6px;
        text-align: center;
        border: 1px solid #e5e7eb;
    }
    
    .analysis-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: #3b82f6;
        margin-bottom: 0.5rem;
    }
    
    .analysis-label {
        font-size: 0.9rem;
        color: #6b7280;
    }
    
    .legal-analysis {
        background: #f0fdf4;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid #d1fae5;
    }
    
    .legal-item {
        background: white;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
        border-left: 3px solid #10b981;
    }
    
    .legal-title {
        font-weight: 600;
        color: #065f46;
        margin-bottom: 0.5rem;
    }
    
    .checklist-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        background: white;
        border: 1px solid #e5e7eb;
    }
    
    .checklist-status {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 1rem;
        flex-shrink: 0;
    }
    
    .status-pass {
        background: #10b981;
    }
    
    .status-fail {
        background: #ef4444;
    }
    
    .checklist-content {
        flex: 1;
    }
    
    .checklist-title {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.25rem;
    }
    
    .checklist-description {
        font-size: 0.9rem;
        color: #6b7280;
    }
    
    .review-guidance {
        background: #fef3c7;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid #f59e0b;
    }
    
    .guidance-requires {
        background: #fee2e2;
        border: 1px solid #ef4444;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .guidance-not-required {
        background: #d1fae5;
        border: 1px solid #10b981;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .extracted-text {
        background: #f8fafc;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e5e7eb;
    }
    
    .text-content {
        background: white;
        padding: 1rem;
        border-radius: 6px;
        max-height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 0.9rem;
        line-height: 1.5;
        white-space: pre-wrap;
    }
    
    .summary-report {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .summary-item {
        text-align: center;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
    }
    
    .summary-number {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .summary-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .action-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        flex-wrap: wrap;
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .btn-secondary {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
    }
    
    .btn-secondary:hover {
        background: #e5e7eb;
    }
    
    @media (max-width: 768px) {
        .result-container {
            padding: 1rem;
        }
        
        .result-header {
            padding: 1.5rem;
        }
        
        .result-header h1 {
            font-size: 1.5rem;
        }
        
        .result-tabs {
            flex-direction: column;
        }
        
        .result-tab {
            min-width: auto;
        }
        
        .content-section {
            padding: 1.5rem;
        }
        
        .analysis-grid {
            grid-template-columns: 1fr;
        }
        
        .summary-grid {
            grid-template-columns: 1fr;
        }
        
        .action-buttons {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="result-container">
    <!-- 결과 헤더 -->
    <div class="result-header">
        <h1>분석 결과</h1>
        <p>의료광고법 준수 검토 완료</p>
        
        <!-- 점수 표시 -->
        <div class="score-display">
            <div class="score-circle {{ result.risk_level }}">
                <div class="score-number">{{ result.overall_score }}</div>
                <div class="score-label">점수</div>
            </div>
        </div>
        
        <!-- 상태 배지 -->
        <div class="status-badge status-{{ result.compliance_status|lower }}">
            {{ result.compliance_status }}
        </div>
    </div>
    
    <!-- 요약 리포트 -->
    <div class="summary-report">
        <h2 class="section-title" style="color: white; border-bottom-color: white;">요약 리포트</h2>
        <div class="summary-grid">
            <div class="summary-item">
                <div class="summary-number">{{ result.summary_report.executive_summary.total_violations }}</div>
                <div class="summary-label">총 위반사항</div>
            </div>
            <div class="summary-item">
                <div class="summary-number">{{ result.summary_report.executive_summary.high_severity }}</div>
                <div class="summary-label">고위험 위반</div>
            </div>
            <div class="summary-item">
                <div class="summary-number">{{ result.summary_report.executive_summary.compliance_score }}</div>
                <div class="summary-label">준수도 점수</div>
            </div>
            <div class="summary-item">
                <div class="summary-number">{{ result.summary_report.executive_summary.risk_assessment|title }}</div>
                <div class="summary-label">위험도</div>
            </div>
        </div>
    </div>
    
    <!-- 결과 탭 -->
    <div class="result-tabs">
        <button class="result-tab active" data-tab="violations">
            <i class="fas fa-exclamation-triangle"></i> 위반사항
        </button>
        <button class="result-tab" data-tab="text-analysis">
            <i class="fas fa-file-alt"></i> 텍스트 분석
        </button>
        <button class="result-tab" data-tab="legal-analysis">
            <i class="fas fa-balance-scale"></i> 법적 분석
        </button>
        <button class="result-tab" data-tab="checklist">
            <i class="fas fa-check-square"></i> 체크리스트
        </button>
        <button class="result-tab" data-tab="review-guidance">
            <i class="fas fa-clipboard-list"></i> 심의 안내
        </button>
        <button class="result-tab" data-tab="extracted-text">
            <i class="fas fa-search"></i> 인식된 텍스트
        </button>
    </div>
    
    <!-- 위반사항 섹션 -->
    <div id="violations" class="content-section active">
        <h2 class="section-title">위반사항 상세</h2>
        
        {% if result.detailed_violations %}
            {% for violation in result.detailed_violations %}
            <div class="violation-card {{ violation.severity }}">
                <div class="violation-header">
                    <div class="violation-title">{{ violation.title }}</div>
                    <div class="violation-severity severity-{{ violation.severity }}">
                        {{ violation.severity|title }}
                    </div>
                </div>
                
                <div class="violation-details">
                    <div>
                        <span class="violation-keyword">{{ violation.keyword }}</span>
                        <span>발견됨</span>
                    </div>
                    
                    <div class="violation-context">
                        "{{ violation.highlighted_context }}"
                    </div>
                    
                    {% if violation.exact_location %}
                    <div style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">
                        <i class="fas fa-map-marker-alt"></i> 정확한 위치: {{ violation.exact_location }}
                    </div>
                    {% endif %}
                    
                    {% if violation.paragraph_context %}
                    <div style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">
                        <i class="fas fa-paragraph"></i> 문단 컨텍스트: {{ violation.paragraph_context|truncatechars:100 }}
                    </div>
                    {% endif %}
                </div>
                
                <div class="violation-suggestions">
                    <strong>개선 제안:</strong>
                    {% for suggestion in violation.suggested_fixes %}
                    <div class="suggestion-item">{{ suggestion }}</div>
                    {% endfor %}
                </div>
                
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                    <div style="font-size: 0.9rem; color: #6b7280;">
                        <strong>법적 근거:</strong> {{ violation.legal_basis }}
                    </div>
                    <div style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">
                        <strong>처벌:</strong> {{ violation.penalty }}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div style="text-align: center; padding: 3rem; color: #6b7280;">
                <i class="fas fa-check-circle" style="font-size: 3rem; color: #10b981; margin-bottom: 1rem;"></i>
                <h3>위반사항이 발견되지 않았습니다</h3>
                <p>입력하신 텍스트는 의료광고법을 준수하고 있습니다.</p>
            </div>
        {% endif %}
    </div>
    
    <!-- 텍스트 분석 섹션 -->
    <div id="text-analysis" class="content-section">
        <h2 class="section-title">텍스트 분석</h2>
        
        <div class="text-analysis">
            <div class="analysis-grid">
                <div class="analysis-item">
                    <div class="analysis-number">{{ result.text_analysis.total_characters }}</div>
                    <div class="analysis-label">총 문자 수</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-number">{{ result.text_analysis.total_words }}</div>
                    <div class="analysis-label">총 단어 수</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-number">{{ result.text_analysis.total_sentences }}</div>
                    <div class="analysis-label">총 문장 수</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-number">{{ result.text_analysis.avg_sentence_length }}</div>
                    <div class="analysis-label">평균 문장 길이</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-number">{{ result.text_analysis.readability_score|floatformat:1 }}</div>
                    <div class="analysis-label">가독성 점수</div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-number">{{ result.text_analysis.text_quality|title }}</div>
                    <div class="analysis-label">텍스트 품질</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 법적 분석 섹션 -->
    <div id="legal-analysis" class="content-section">
        <h2 class="section-title">법적 분석</h2>
        
        <div class="legal-analysis">
            <h3 style="color: #065f46; margin-bottom: 1rem;">적용 가능한 법령</h3>
            {% for law in result.legal_analysis.applicable_laws %}
            <div class="legal-item">
                <div class="legal-title">{{ law.law }}</div>
                <div style="font-size: 0.9rem; color: #6b7280;">
                    <strong>조항:</strong> {{ law.articles|join:", " }}
                </div>
                <div style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">
                    {{ law.description }}
                </div>
            </div>
            {% endfor %}
            
            {% if result.legal_analysis.legal_risks %}
            <h3 style="color: #065f46; margin: 2rem 0 1rem 0;">법적 위험 요소</h3>
            {% for risk in result.legal_analysis.legal_risks %}
            <div class="legal-item">
                <div class="legal-title">{{ risk.risk_type }}</div>
                <div style="font-size: 0.9rem; color: #6b7280;">
                    <strong>심각도:</strong> {{ risk.severity|title }}
                </div>
                <div style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">
                    <strong>완화 방안:</strong> {{ risk.mitigation }}
                </div>
            </div>
            {% endfor %}
            {% endif %}
        </div>
    </div>
    
    <!-- 체크리스트 섹션 -->
    <div id="checklist" class="content-section">
        <h2 class="section-title">준수 체크리스트</h2>
        
        {% for item in result.compliance_checklist %}
        <div class="checklist-item" style="flex-direction: column; align-items: flex-start;">
            <div style="display: flex; align-items: center; width: 100%; margin-bottom: 1rem;">
                <div class="checklist-status status-{{ item.status }}"></div>
                <div class="checklist-content">
                    <div class="checklist-title">{{ item.title }}</div>
                    <div class="checklist-description">{{ item.description }}</div>
                    <div style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">
                        <strong>준수 점수:</strong> {{ item.compliance_score }}/100
                        {% if item.violation_count > 0 %}
                        <span style="margin-left: 1rem; color: #ef4444;">
                            <strong>위반 건수:</strong> {{ item.violation_count }}건
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- 상세 분석 정보 -->
            {% if item.detailed_analysis %}
            <div style="width: 100%; margin-top: 1rem; padding: 1rem; background: #f8fafc; border-radius: 6px;">
                <h4 style="color: #1f2937; margin-bottom: 1rem; font-size: 1.1rem;">
                    <i class="fas fa-search"></i> 상세 분석
                </h4>
                
                <!-- 통과/실패 사유 -->
                {% if item.status == 'pass' and item.detailed_analysis.pass_reasons %}
                <div style="margin-bottom: 1rem;">
                    <h5 style="color: #10b981; margin-bottom: 0.5rem;">
                        <i class="fas fa-check"></i> 통과 사유
                    </h5>
                    <ul style="margin-left: 1rem; color: #065f46;">
                        {% for reason in item.detailed_analysis.pass_reasons %}
                        <li>{{ reason }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                {% if item.status == 'fail' and item.detailed_analysis.fail_reasons %}
                <div style="margin-bottom: 1rem;">
                    <h5 style="color: #ef4444; margin-bottom: 0.5rem;">
                        <i class="fas fa-times"></i> 실패 사유
                    </h5>
                    <ul style="margin-left: 1rem; color: #991b1b;">
                        {% for reason in item.detailed_analysis.fail_reasons %}
                        <li>{{ reason }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- 위반 상세 정보 -->
                {% if item.detailed_analysis.violation_details %}
                <div style="margin-bottom: 1rem;">
                    <h5 style="color: #ef4444; margin-bottom: 0.5rem;">
                        <i class="fas fa-exclamation-triangle"></i> 위반 상세
                    </h5>
                    {% for violation in item.detailed_analysis.violation_details %}
                    <div style="background: white; padding: 1rem; border-radius: 6px; margin-bottom: 0.5rem; border-left: 3px solid #ef4444;">
                        <div style="font-weight: 600; color: #991b1b; margin-bottom: 0.5rem;">
                            키워드: <span style="background: #fee2e2; padding: 0.2rem 0.5rem; border-radius: 3px;">{{ violation.keyword }}</span>
                        </div>
                        <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 0.5rem;">
                            <strong>위반 사유:</strong> {{ violation.why_violation }}
                        </div>
                        <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 0.5rem;">
                            <strong>위치:</strong> {{ violation.position }}
                        </div>
                        <div style="font-size: 0.9rem; color: #6b7280;">
                            <strong>맥락:</strong> "{{ violation.context|truncatechars:100 }}"
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- 증거 및 근거 -->
                {% if item.detailed_analysis.evidence %}
                <div style="margin-bottom: 1rem;">
                    <h5 style="color: #3b82f6; margin-bottom: 0.5rem;">
                        <i class="fas fa-clipboard-check"></i> 증거 및 근거
                    </h5>
                    {% for evidence in item.detailed_analysis.evidence %}
                    <div style="background: white; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; border-left: 3px solid #3b82f6;">
                        <div style="font-size: 0.9rem;">
                            {% if evidence.type == 'violation' %}
                            <span style="color: #ef4444;">위반 증거:</span> "{{ evidence.keyword }}" - {{ evidence.legal_basis }}
                            {% else %}
                            <span style="color: #10b981;">준수 증거:</span> {{ evidence.description }}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- 맥락 분석 -->
                {% if item.detailed_analysis.context_analysis %}
                <div style="margin-bottom: 1rem;">
                    <h5 style="color: #8b5cf6; margin-bottom: 0.5rem;">
                        <i class="fas fa-chart-line"></i> 맥락 분석
                    </h5>
                    <div style="background: white; padding: 1rem; border-radius: 6px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                            <div>
                                <strong>텍스트 톤:</strong> 
                                                            <span style="color: {% if item.detailed_analysis.context_analysis.tone == 'promotional' %}#ef4444{% elif item.detailed_analysis.context_analysis.tone == 'objective' %}#10b981{% else %}#6b7280{% endif %}">
                                {{ item.detailed_analysis.context_analysis.tone|title }}
                            </span>
                            </div>
                            <div>
                                <strong>객관성 점수:</strong> 
                                <span style="color: {% if item.detailed_analysis.context_analysis.objectivity_score >= 70 %}#10b981{% elif item.detailed_analysis.context_analysis.objectivity_score >= 40 %}#f59e0b{% else %}#ef4444{% endif %}">
                                    {{ item.detailed_analysis.context_analysis.objectivity_score|floatformat:1 }}%
                                </span>
                            </div>
                            <div>
                                <strong>주관성:</strong> 
                                <span style="color: {% if item.detailed_analysis.context_analysis.subjectivity <= 0.3 %}#10b981{% elif item.detailed_analysis.context_analysis.subjectivity <= 0.6 %}#f59e0b{% else %}#ef4444{% endif %}">
                                    {{ item.detailed_analysis.context_analysis.subjectivity|floatformat:2 }}
                                </span>
                            </div>
                        </div>
                        
                        {% if item.detailed_analysis.context_analysis.medical_terminology %}
                        <div style="margin-top: 1rem;">
                            <strong>의료 용어:</strong> 
                            <span style="color: #6b7280;">{{ item.detailed_analysis.context_analysis.medical_terminology|join:", " }}</span>
                        </div>
                        {% endif %}
                        
                        {% if item.detailed_analysis.context_analysis.advertising_elements %}
                        <div style="margin-top: 0.5rem;">
                            <strong>광고 요소:</strong> 
                            <span style="color: #6b7280;">{{ item.detailed_analysis.context_analysis.advertising_elements|join:", " }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- 키워드 분석 -->
                {% if item.detailed_analysis.keyword_analysis %}
                <div style="margin-bottom: 1rem;">
                    <h5 style="color: #f59e0b; margin-bottom: 0.5rem;">
                        <i class="fas fa-key"></i> 키워드 분석
                    </h5>
                    <div style="background: white; padding: 1rem; border-radius: 6px;">
                        <div style="margin-bottom: 0.5rem;">
                            <strong>전체 키워드:</strong> {{ item.detailed_analysis.keyword_analysis.total_keywords }}개
                        </div>
                        {% if item.detailed_analysis.keyword_analysis.found_keywords %}
                        <div style="margin-bottom: 0.5rem;">
                            <strong>발견된 키워드:</strong> 
                            {% for keyword in item.detailed_analysis.keyword_analysis.found_keywords %}
                            <span style="background: #fef3c7; padding: 0.2rem 0.5rem; border-radius: 3px; margin-right: 0.5rem; font-size: 0.9rem;">
                                {{ keyword }} ({{ item.detailed_analysis.keyword_analysis.keyword_frequency|get_item:keyword|default:1 }}회)
                            </span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- 개선 권장사항 -->
                {% if item.detailed_analysis.recommendations %}
                <div>
                    <h5 style="color: #10b981; margin-bottom: 0.5rem;">
                        <i class="fas fa-lightbulb"></i> 개선 권장사항
                    </h5>
                    <ul style="margin-left: 1rem; color: #065f46;">
                        {% for recommendation in item.detailed_analysis.recommendations %}
                        <li>{{ recommendation }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    <!-- 심의 안내 섹션 -->
    <div id="review-guidance" class="content-section">
        <h2 class="section-title">심의 안내</h2>
        
        <div class="review-guidance">
            {% if result.review_guidance.requires_review %}
            <div class="guidance-requires">
                <h3 style="color: #991b1b; margin-bottom: 1rem;">
                    <i class="fas fa-exclamation-triangle"></i> 심의 필요
                </h3>
                <div style="margin-bottom: 1rem;">
                    <strong>심의 유형:</strong> {{ result.review_guidance.review_type }}
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong>심의비:</strong> {{ result.review_guidance.review_fee }}
                </div>
                {% if result.review_guidance.deadline %}
                <div style="margin-bottom: 1rem;">
                    <strong>접수 마감:</strong> {{ result.review_guidance.deadline }}
                </div>
                {% endif %}
                
                {% if result.review_guidance.review_process %}
                <div style="margin-bottom: 1rem;">
                    <strong>심의 절차:</strong>
                    <ul style="margin-top: 0.5rem; margin-left: 1rem;">
                        {% for step in result.review_guidance.review_process %}
                        <li>{{ step }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                {% if result.review_guidance.submission_requirements %}
                <div style="margin-bottom: 1rem;">
                    <strong>구비서류:</strong>
                    <ul style="margin-top: 0.5rem; margin-left: 1rem;">
                        {% for requirement in result.review_guidance.submission_requirements %}
                        <li>{{ requirement }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="guidance-not-required">
                <h3 style="color: #065f46; margin-bottom: 1rem;">
                    <i class="fas fa-check-circle"></i> 심의 불필요
                </h3>
                <p>현재 광고물은 사전심의가 필요하지 않습니다.</p>
            </div>
            {% endif %}
            
            {% if result.review_guidance.notes %}
            <div style="margin-top: 1rem;">
                <strong>참고사항:</strong>
                <ul style="margin-top: 0.5rem; margin-left: 1rem;">
                    {% for note in result.review_guidance.notes %}
                    <li>{{ note }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            {% if result.review_guidance.penalties %}
            <div style="margin-top: 1rem;">
                <strong>처벌 기준:</strong>
                <ul style="margin-top: 0.5rem; margin-left: 1rem;">
                    {% for penalty in result.review_guidance.penalties %}
                    <li>{{ penalty.type }}: {{ penalty.amount }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 인식된 텍스트 섹션 -->
    <div id="extracted-text" class="content-section active">
        <h2 class="section-title">인식된 텍스트</h2>
        
        <div class="extracted-text">
            <div style="margin-bottom: 1rem;">
                <h4 style="color: #374151; margin-bottom: 0.5rem;">
                    <i class="fas fa-file-alt"></i> 분석 대상 텍스트
                </h4>
                <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 1rem;">
                    <strong>텍스트 길이:</strong> {{ result.text_analysis.total_characters }}자 / 
                    <strong>단어 수:</strong> {{ result.text_analysis.total_words }}개 / 
                    <strong>문장 수:</strong> {{ result.text_analysis.total_sentences }}개
                </div>
            </div>
            
            <div class="text-content" style="background: #f9fafb; border: 1px solid #d1d5db;">
                <div style="padding: 1rem; background: white; border-radius: 4px; margin-bottom: 1rem;">
                    <strong style="color: #374151;">원본 텍스트(위반 키워드 하이라이트):</strong>
                </div>
                <div style="padding: 1rem; background: white; border-radius: 4px; max-height: 1200px; overflow-y: auto;">
                    {% with text=result.extracted_text violations=result.detailed_violations %}
                        {{ text|highlight_violations:violations|safe }}
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- 위반 항목 상세 분석 전체 노출 -->
    {% if result.detailed_violations %}
    <div style="margin-top: 2rem;">
        <h2 class="section-title"><i class="fas fa-search"></i> 위반 항목 상세 분석</h2>
        <div style="background: white; padding: 1.5rem; border-radius: 10px; border: 1px solid #d1d5db;">
            {% for violation in result.detailed_violations %}
            <div style="margin-bottom: 2.5rem; padding: 1.5rem; background: #fef2f2; border-radius: 8px; border-left: 5px solid #ef4444;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div style="font-weight: 700; color: #991b1b; font-size: 1.1rem;">
                        <i class="fas fa-exclamation-triangle"></i> {{ violation.keyword }}
                    </div>
                    <div style="font-size: 0.9rem; color: #6b7280;">
                        <i class="fas fa-map-marker-alt"></i> {{ violation.text_position }}
                    </div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                        <i class="fas fa-quote-left"></i> 위반 문맥
                    </div>
                    <div style="background: white; padding: 1rem; border-radius: 4px; border: 1px solid #d1d5db; font-style: italic;">
                        "{{ violation.highlighted_context }}"
                    </div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                        <i class="fas fa-info-circle"></i> 상세 위치 정보
                    </div>
                    <div style="font-size: 0.9rem; color: #6b7280;">
                        <div><strong>정확한 위치:</strong> {{ violation.detailed_location }}</div>
                        <div><strong>문장 내 위치:</strong> {{ violation.sentence_position }}</div>
                        <div><strong>즉시 문맥:</strong> "{{ violation.immediate_context }}"</div>
                    </div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                        <i class="fas fa-gavel"></i> 법적 정보
                    </div>
                    <div style="font-size: 0.9rem; color: #6b7280;">
                        <div><strong>법적 근거:</strong> {{ violation.legal_basis }}</div>
                        <div><strong>처벌 내용:</strong> {{ violation.penalty }}</div>
                    </div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                        <i class="fas fa-lightbulb"></i> 기본 개선 방안
                    </div>
                    <div style="font-size: 0.9rem; color: #065f46;">
                        {% for fix in violation.suggested_fixes %}
                        <div style="margin-bottom: 0.5rem;">• {{ fix }}</div>
                        {% endfor %}
                    </div>
                </div>
                {% if violation.ai_suggestions %}
                <div style="margin-bottom: 1rem;">
                    <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                        <i class="fas fa-robot"></i> AI 개선 방안
                    </div>
                    <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 6px; padding: 1rem;">
                        <div><strong>대체 키워드:</strong> {{ violation.ai_suggestions.improved_keyword }}</div>
                        <div><strong>개선된 문장:</strong> {{ violation.ai_suggestions.improved_sentence }}</div>
                        <div><strong>대안 표현:</strong> {{ violation.ai_suggestions.alternative_expressions|join:', ' }}</div>
                        <div><strong>추가 권장사항:</strong> {{ violation.ai_suggestions.additional_recommendations|join:', ' }}</div>
                        <div><strong>법적 준수 참고사항:</strong> {{ violation.ai_suggestions.legal_compliance_notes }}</div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- 액션 버튼 -->
    <div class="action-buttons">
        <a href="{% url 'index' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> 새 분석
        </a>
        <a href="{% url 'history' %}" class="btn btn-secondary">
            <i class="fas fa-history"></i> 분석 기록
        </a>
        <button class="btn btn-secondary" onclick="window.print()">
            <i class="fas fa-print"></i> 결과 출력
        </button>
        <button class="btn btn-secondary" onclick="downloadReport()">
            <i class="fas fa-download"></i> 리포트 다운로드
        </button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.result-tab');
    const sections = document.querySelectorAll('.content-section');
    
    // 탭 클릭 이벤트
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');
            
            // 탭 활성화 상태 변경
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // 섹션 표시/숨김
            sections.forEach(section => {
                section.classList.remove('active');
                if (section.id === targetTab) {
                    section.classList.add('active');
                }
            });
        });
    });
});

// 리포트 다운로드
function downloadReport() {
    const reportData = {
        timestamp: new Date().toISOString(),
        score: {{ result.overall_score }},
        status: "{{ result.compliance_status }}",
        violations: {{ result.detailed_violations|safe }},
        summary: {{ result.summary_report|safe }}
    };
    
    const blob = new Blob([JSON.stringify(reportData, null, 2)], {
        type: 'application/json'
    });
    
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `의료광고법-분석결과-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// AI 개선 방안 생성
function getAIImprovements(index, violation) {
    const button = event.target;
    const improvementsDiv = document.getElementById(`ai-improvements-${index}`);
    
    // 버튼 상태 변경
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AI 분석 중...';
    
    // API 호출
    fetch('/api/violation-improvements/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            violation: violation,
            original_text: `{{ result.extracted_text|escapejs }}`
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const suggestions = data.suggestions;
            improvementsDiv.innerHTML = `
                <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 6px; padding: 1rem;">
                    <h6 style="color: #0c4a6e; margin-bottom: 1rem;">
                        <i class="fas fa-robot"></i> AI 개선 방안
                    </h6>
                    
                    <div style="margin-bottom: 1rem;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                            <i class="fas fa-edit"></i> 개선된 표현
                        </div>
                        <div style="background: white; padding: 0.75rem; border-radius: 4px; border: 1px solid #d1d5db;">
                            <strong>대체 키워드:</strong> ${suggestions.improved_keyword || '제안 없음'}<br>
                            <strong>개선된 문장:</strong> ${suggestions.improved_sentence || '제안 없음'}
                        </div>
                    </div>
                    
                    ${suggestions.alternative_expressions && suggestions.alternative_expressions.length > 0 ? `
                    <div style="margin-bottom: 1rem;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                            <i class="fas fa-list"></i> 대안 표현
                        </div>
                        <div style="background: white; padding: 0.75rem; border-radius: 4px; border: 1px solid #d1d5db;">
                            ${suggestions.alternative_expressions.map(expr => `• ${expr}`).join('<br>')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${suggestions.additional_recommendations && suggestions.additional_recommendations.length > 0 ? `
                    <div style="margin-bottom: 1rem;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                            <i class="fas fa-lightbulb"></i> 추가 권장사항
                        </div>
                        <div style="background: white; padding: 0.75rem; border-radius: 4px; border: 1px solid #d1d5db;">
                            ${suggestions.additional_recommendations.map(rec => `• ${rec}`).join('<br>')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${suggestions.legal_compliance_notes ? `
                    <div>
                        <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                            <i class="fas fa-gavel"></i> 법적 준수 참고사항
                        </div>
                        <div style="background: white; padding: 0.75rem; border-radius: 4px; border: 1px solid #d1d5db; font-size: 0.9rem;">
                            ${suggestions.legal_compliance_notes}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        } else {
            improvementsDiv.innerHTML = `
                <div style="background: #fef2f2; border: 1px solid #ef4444; border-radius: 6px; padding: 1rem;">
                    <div style="color: #991b1b;">
                        <i class="fas fa-exclamation-triangle"></i> AI 분석 실패
                    </div>
                    <div style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">
                        ${data.error || '알 수 없는 오류가 발생했습니다.'}
                    </div>
                </div>
            `;
        }
        improvementsDiv.style.display = 'block';
    })
    .catch(error => {
        console.error('Error:', error);
        improvementsDiv.innerHTML = `
            <div style="background: #fef2f2; border: 1px solid #ef4444; border-radius: 6px; padding: 1rem;">
                <div style="color: #991b1b;">
                    <i class="fas fa-exclamation-triangle"></i> 네트워크 오류
                </div>
                <div style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">
                    AI 분석 중 오류가 발생했습니다. 다시 시도해주세요.
                </div>
            </div>
        `;
        improvementsDiv.style.display = 'block';
    })
    .finally(() => {
        // 버튼 상태 복원
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-robot"></i> AI 개선 방안 생성';
    });
}

// 중복 제거 함수들
function removeDuplicateViolations(violations) {
    const seen = new Set();
    const uniqueViolations = [];
    
    violations.forEach(violation => {
        const key = `${violation.category}-${violation.title}-${violation.keyword}-${violation.position}`;
        if (!seen.has(key)) {
            seen.add(key);
            uniqueViolations.push(violation);
        }
    });
    
    return uniqueViolations;
}

function consolidateSimilarViolations(violations) {
    const consolidated = {};
    
    violations.forEach(violation => {
        const key = `${violation.category}-${violation.title}`;
        if (consolidated[key]) {
            consolidated[key].count = (consolidated[key].count || 1) + (violation.count || 1);
            if (violation.severity === 'high') {
                consolidated[key].severity = 'high';
            } else if (violation.severity === 'medium' && consolidated[key].severity !== 'high') {
                consolidated[key].severity = 'medium';
            }
        } else {
            consolidated[key] = { ...violation };
        }
    });
    
    return Object.values(consolidated);
}

function removeDuplicateRecommendations(recommendations) {
    const seen = new Set();
    const uniqueRecommendations = [];
    
    recommendations.forEach(recommendation => {
        const key = `${recommendation.category}-${recommendation.title}`;
        if (!seen.has(key)) {
            seen.add(key);
            uniqueRecommendations.push(recommendation);
        }
    });
    
    return uniqueRecommendations;
}

// 페이지 로드 시 중복 제거 적용
document.addEventListener('DOMContentLoaded', function() {
    // 기존 탭 이벤트 리스너
    const tabs = document.querySelectorAll('.result-tab');
    const sections = document.querySelectorAll('.content-section');
    
    // 탭 클릭 이벤트
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');
            
            // 탭 활성화 상태 변경
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // 섹션 표시/숨김
            sections.forEach(section => {
                section.classList.remove('active');
                if (section.id === targetTab) {
                    section.classList.add('active');
                }
            });
        });
    });
    
    // 중복 제거 적용 (서버에서 이미 처리되었지만 추가 보장)
    console.log('중복 제거 로직이 적용되었습니다.');
});

// CSRF 토큰 가져오기
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %} 