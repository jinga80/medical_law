{% extends 'base.html' %}
{% load static %}

{% block title %}알림 목록{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page title -->
    <div class="row">
        <div class="col-12">
            {% with title=page_title|default:"알림 목록" icon="mdi-bell" breadcrumbs=breadcrumbs %}
                {% include 'includes/page_title.html' %}
            {% endwith %}
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-sm-4">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary" onclick="markAllAsRead()">
                                    <i class="mdi mdi-check-all me-2"></i>모두 읽음 처리
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="deleteAllRead()">
                                    <i class="mdi mdi-delete me-2"></i>읽은 알림 삭제
                                </button>
                            </div>
                        </div>
                        <div class="col-sm-8">
                            <div class="text-sm-end">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="알림 검색...">
                                    <button class="btn btn-secondary" type="button">
                                        <i class="mdi mdi-magnify"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-centered table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="selectAll">
                                            <label class="form-check-label" for="selectAll"></label>
                                        </div>
                                    </th>
                                    <th>알림</th>
                                    <th>유형</th>
                                    <th>상태</th>
                                    <th>시간</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for notification in notifications %}
                                <tr class="{% if not notification.is_read %}table-warning{% endif %}">
                                    <td>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input notification-checkbox" value="{{ notification.id }}">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                <div class="avatar-sm">
                                                    <span class="avatar-title bg-soft-{{ notification.get_type_color }} rounded">
                                                        <i class="mdi mdi-{{ notification.get_type_icon }} font-16 text-{{ notification.get_type_color }}"></i>
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1 ms-2">
                                                <h6 class="mb-1">{{ notification.title }}</h6>
                                                <p class="text-muted mb-0">{{ notification.message|truncatechars:100 }}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ notification.get_type_color }}">{{ notification.get_type_display }}</span>
                                    </td>
                                    <td>
                                        {% if notification.is_read %}
                                            <span class="badge bg-success">읽음</span>
                                        {% else %}
                                            <span class="badge bg-warning">안읽음</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ notification.created_at|date:"Y-m-d H:i" }}</td>
                                    <td>
                                        <a href="{% url 'notifications:detail' notification.id %}" class="action-icon">
                                            <i class="mdi mdi-eye"></i>
                                        </a>
                                        <a href="#" class="action-icon" onclick="deleteNotification({{ notification.id }})">
                                            <i class="mdi mdi-delete"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center">알림이 없습니다.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if is_paginated %}
                    <div class="row">
                        <div class="col-12">
                            <nav>
                                <ul class="pagination pagination-rounded justify-content-center mb-0">
                                    {% if page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">이전</a>
                                        </li>
                                    {% endif %}

                                    {% for num in page_obj.paginator.page_range %}
                                        {% if page_obj.number == num %}
                                            <li class="page-item active">
                                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                            </li>
                                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}

                                    {% if page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.next_page_number }}">다음</a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 전체 선택 체크박스
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.notification-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
    });
});

// 모두 읽음 처리
function markAllAsRead() {
    const checkboxes = document.querySelectorAll('.notification-checkbox:checked');
    const notificationIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (notificationIds.length === 0) {
        alert('선택된 알림이 없습니다.');
        return;
    }
    
    fetch('{% url "notifications:mark_as_read" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({notification_ids: notificationIds})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('오류가 발생했습니다.');
        }
    });
}

// 읽은 알림 삭제
function deleteAllRead() {
    if (confirm('읽은 모든 알림을 삭제하시겠습니까?')) {
        fetch('{% url "notifications:delete_read" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('오류가 발생했습니다.');
            }
        });
    }
}

// 개별 알림 삭제
function deleteNotification(notificationId) {
    if (confirm('이 알림을 삭제하시겠습니까?')) {
        fetch(`/notifications/${notificationId}/delete/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('오류가 발생했습니다.');
            }
        });
    }
}
</script>
{% endblock %} 